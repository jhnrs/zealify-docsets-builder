name: Build Docsets (Parallel)

on:
  workflow_dispatch:
    inputs:
      target_id:
        description: 'Which docset to build?'
        required: true
        default: 'All'
        type: choice
        options: [All, Markdown, Flutter-API, Dart-Language, React-Native] # Added React-Native here
  schedule:
    - cron: '0 0 1 * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: "Markdown"
            name: "Markdown"
            type: "scrape"
            url: "https://www.markdownguide.org/"
          - id: "Flutter-API"
            name: "Flutter-API"
            type: "download"
            url: "https://api.flutter.dev/offline/flutter.docs.zip"
          - id: "Dart-Language"
            name: "Dart-Language"
            type: scrape
            url: "https://dart.dev/docs"
          - id: "React-Native"
            name: "React-Native"
            type: "git-build" # Changed from 'download' to 'git-build'
            url: "https://github.com/facebook/react-native-website.git"

    steps:
      - name: Checkout Code
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        uses: actions/checkout@v4

      - name: Install Go
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install Dashing
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        run: go install github.com/technosophos/dashing@latest

      # --- React Native Specific Setup ---
      - name: Setup Node.js (React Native only)
        if: matrix.id == 'React-Native' && (github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule')
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build React Native Website
        if: matrix.id == 'React-Native' && (github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule')
        run: |
          git clone --depth 1 ${{ matrix.url }} rn-repo
          cd rn-repo/website
          # Use 'npm install' to ensure all binaries are placed in node_modules/.bin
          npm install 
          # Use 'npx' to ensure it finds the docusaurus command locally
          npx docusaurus build
          mkdir -p ../../staging
          cp -r build/* ../../staging/
      # -----------------------------------

      - name: Scrape Website (Others)
        if: matrix.type == 'scrape' && (github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule')
        run: |
          mkdir staging
          wget --mirror --convert-links --adjust-extension --page-requisites --no-parent --no-host-directories \
               --directory-prefix=staging --user-agent="Mozilla/5.0" --execute robots=off \
               ${{ matrix.url }} || true

      - name: Download and Unpack SDK Docs (Flutter)
        if: matrix.type == 'download' && (github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule')
        run: |
          mkdir staging
          wget -O docs.zip ${{ matrix.url }}
          unzip docs.zip -d staging
          rm docs.zip

      - name: Build with Dashing
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        run: |
          # Use our specific template logic
          sed -e 's/{{NAME}}/${{ matrix.name }}/g' -e 's/{{PACKAGE}}/${{ matrix.id }}/g' dashing.template.json > staging/dashing.json
          cd staging && ~/go/bin/dashing build ${{ matrix.id }}

      - name: Package Docset
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        run: |
          cd staging
          tar -czf ../${{ matrix.id }}.docset.tar.gz ${{ matrix.id }}.docset

      - name: Create Release
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.id }}.docset.tar.gz
          tag_name: "v${{ github.run_number }}"
          name: "Docset Release v${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}