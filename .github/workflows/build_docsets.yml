name: Build Docsets (Parallel)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - id: "Markdown"        # Changed from "markdownguide"
            name: "Markdown"      # Human-friendly name
            type: "scrape"
            url: "https://www.markdownguide.org/"
          - id: "Flutter"         # Changed from "flutter"
            name: "Flutter"       # Human-friendly name
            type: "download"
            url: "https://api.flutter.dev/offline/flutter.zip"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Tooling Setup ---
      - name: Install Go & Dashing
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install Dashing
        run: go install github.com/technosophos/dashing@latest

      # --- Step A: Scraping (for Markdown) ---
      - name: Scrape Website
        if: matrix.type == 'scrape'
        run: |
          mkdir staging
          # We use --no-host-directories to prevent nested 'www.markdownguide.org' folders
          wget --mirror --convert-links --adjust-extension --page-requisites --no-parent --no-host-directories \
               --directory-prefix=staging --user-agent="Mozilla/5.0" --execute robots=off \
               ${{ matrix.url }} || true

      # --- Step B: Download & Clean (for Flutter) ---
      - name: Download and Unpack SDK Docs
        if: matrix.type == 'download'
        run: |
          mkdir staging
          wget -O flutter_docs.zip ${{ matrix.url }}
          unzip flutter_docs.zip -d temp_extract
          # Flattening the directory to focus on standard Zeal structure
          # We move everything from the extracted 'flutter' folder into staging
          mv temp_extract/*/* staging/ || mv temp_extract/* staging/
          rm -rf temp_extract flutter_docs.zip

      # --- Dashing Stage ---
      - name: Build with Dashing
        run: |
          # Replace placeholders in the template and save as the real dashing.json
          sed -e 's/{{NAME}}/${{ matrix.name }}/g' \
              -e 's/{{PACKAGE}}/${{ matrix.id }}/g' \
              dashing.template.json > staging/dashing.json
          
          cd staging
          ~/go/bin/dashing build ${{ matrix.id }}

      # --- Packaging (Standard Zeal Structure) ---
      - name: Package Docset
        run: |
          # Create a compressed tarball: Markdown.docset.tar.gz or Flutter.docset.tar.gz
          cd staging
          tar -czf ../${{ matrix.id }}.docset.tar.gz ${{ matrix.id }}.docset

      # --- Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.id }}.docset.tar.gz
          tag_name: "v${{ github.run_number }}"
          name: "Docset Release v${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
