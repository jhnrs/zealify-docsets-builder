name: Build Docsets (Parallel)

on:
  workflow_dispatch:
    inputs:
      target_id:
        description: 'Which docset to build? (Markdown, Flutter, or All)'
        required: true
        default: 'All'
        type: choice
        options: [All, Markdown, Flutter]
  schedule:
    - cron: '0 0 1 * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: "Markdown"
            name: "Markdown"
            type: "scrape"
            url: "https://www.markdownguide.org/"
          - id: "Flutter API"
            name: "Flutter API"
            type: "download"
            url: "https://api.flutter.dev/offline/flutter.docs.zip"
          - id: "Dart Language"
            name: "Dart Language"
            type: scrape
            url: "https://dart.dev/docs"

    steps:
      # Use step-level conditionals to allow matrix.id access
      - name: Checkout Code
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        uses: actions/checkout@v4

      - name: Install Go & Dashing
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install Dashing
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        run: go install github.com/technosophos/dashing@latest

      - name: Scrape Website (Markdown)
        if: matrix.type == 'scrape' && (github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule')
        run: |
          mkdir staging
          wget --mirror --convert-links --adjust-extension --page-requisites --no-parent --no-host-directories \
               --directory-prefix=staging --user-agent="Mozilla/5.0" --execute robots=off \
               ${{ matrix.url }} || true

      - name: Download and Unpack SDK Docs (Original Structure)
        if: matrix.type == 'download' && (github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule')
        run: |
          mkdir staging
          wget -O flutter_docs.zip ${{ matrix.url }}
          unzip flutter_docs.zip -d staging
          rm flutter_docs.zip

      - name: Build with Dashing
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        run: |
          sed -e 's/{{NAME}}/${{ matrix.name }}/g' -e 's/{{PACKAGE}}/${{ matrix.id }}/g' dashing.template.json > staging/dashing.json
          cd staging && ~/go/bin/dashing build ${{ matrix.id }}

      - name: Package Docset
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        run: |
          cd staging
          tar -czf ../${{ matrix.id }}.docset.tar.gz ${{ matrix.id }}.docset

      - name: Create Release
        if: github.event.inputs.target_id == 'All' || github.event.inputs.target_id == matrix.id || github.event_name == 'schedule'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.id }}.docset.tar.gz
          tag_name: "v${{ github.run_number }}"
          name: "Docset Release v${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
