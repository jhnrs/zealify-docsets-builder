name: Build Docsets (Parallel)

on:
  workflow_dispatch:
    inputs:
      target_id:
        description: 'Which docset to build? (Markdown, Flutter, or All)'
        required: true
        default: 'All'
        type: choice
        options:
          - All
          - Markdown
          - Flutter
  schedule:
    - cron: '0 0 1 * *'

jobs:
  build:
    runs-on: ubuntu-latest
    # Removed the job-level 'if' because it can't see matrix.id
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: "Markdown"
            name: "Markdown"
            type: "scrape"
            url: "https://www.markdownguide.org/"
          - id: "Flutter"
            name: "Flutter"
            type: "download"
            url: "https://api.flutter.dev/offline/flutter.docs.zip"

    steps:
      - name: Checkout Code
        # This step and all below now check your manual selection
        if: |
          github.event_name == 'schedule' || 
          inputs.target_id == 'All' || 
          inputs.target_id == matrix.id
        uses: actions/checkout@v4

      - name: Process Flutter Package
        # You must repeat the check for every major step
        if: |
          matrix.type == 'download' && 
          (github.event_name == 'schedule' || inputs.target_id == 'All' || inputs.target_id == matrix.id)
        run: |
          mkdir staging
          wget -O flutter_docs.zip ${{ matrix.url }}
          unzip flutter_docs.zip -d temp_extract
          mv temp_extract/**/dev/docs/doc/* staging/
          rm -rf temp_extract flutter_docs.zip

      # --- Step C: Final Packaging ---
      - name: Package to Tarball
        run: |
          # Use tar -czf to create the .tar.gz file for Zeal compatibility
          cd staging
          tar -czf ../${{ matrix.id }}.docset.tar.gz .

      # --- Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.id }}.docset.tar.gz
          tag_name: "v${{ github.run_number }}"
          name: "Docset Release v${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
